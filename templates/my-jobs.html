{% extends "base.html" %}

{% block title %}My Jobs - FreelanceHub{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold">My Jobs</h1>
        <a href="{{ url_for('post_job') }}" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
            <i class="fas fa-plus"></i> Post New Job
        </a>
    </div>

    <!-- Filter -->
    <div class="bg-white p-4 rounded-lg shadow-md">
        <form method="GET" action="{{ url_for('my_jobs') }}" class="flex gap-4">
            <select name="status" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none">
                <option value="">All Statuses</option>
                <option value="open" {% if status == 'open' %}selected{% endif %}>Open</option>
                <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>In Progress</option>
                <option value="completed" {% if status == 'completed' %}selected{% endif %}>Completed</option>
                <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                Filter
            </button>
        </form>
    </div>

    {% if jobs %}
        <div class="space-y-4">
            {% for job in jobs %}
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="grid md:grid-cols-5 gap-4 items-start">
                        <div class="md:col-span-2">
                            <h3 class="text-xl font-bold mb-2">{{ job.title }}</h3>
                            <p class="text-gray-600 text-sm mb-3">{{ job.description[:100] }}...</p>
                            <span class="inline-block bg-blue-100 text-blue-600 px-3 py-1 rounded text-sm font-semibold">{{ job.category|capitalize }}</span>
                        </div>
                        <div>
                            <p class="text-gray-600 text-sm">Budget</p>
                            <p class="text-2xl font-bold text-green-600">â‚¹{{ "%.2f"|format(job.budget) }}</p>
                        </div>
                        <div>
                            <p class="text-gray-600 text-sm">Bids</p>
                            <p class="text-2xl font-bold">{{ job.bids|length }}</p>
                        </div>
                        <div class="text-right">
                            <span class="inline-block px-4 py-2 rounded-full text-sm font-bold
                                {% if job.status == 'open' %}bg-green-100 text-green-700
                                {% elif job.status == 'in_progress' %}bg-blue-100 text-blue-700
                                {% elif job.status == 'completed' %}bg-gray-100 text-gray-700
                                {% else %}bg-red-100 text-red-700{% endif %}">
                                {{ job.status|capitalize|replace('_', ' ') }}
                            </span>
                        </div>
                        </div>

                    <div class="mt-4 pt-4 border-t flex gap-2">
                        <a href="{{ url_for('job_detail', job_id=job.id) }}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300">
                            View Details
                        </a>
                        {% if job.status == 'open' %}
                            <a href="{{ url_for('view_bids', job_id=job.id) }}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                <i class="fas fa-comments"></i> View Bids
                            </a>
                        {% elif job.status in ['in_progress', 'awaiting_payment'] and job.accepted_bid_id %}
                            <a href="{{ url_for('view_work', job_id=job.id) }}" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                View Work
                            </a>
                            {# Show Pay Now only after client approves submitted work and payment not yet completed #}
                            {% if job.work_submission and job.work_submission.status == 'approved' and (not job.payment or job.payment.status != 'paid') %}
                                <a href="{{ url_for('payment_page', job_id=job.id) }}" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                                    <i class="fas fa-credit-card"></i> Pay Now
                                </a>
                            {% endif %}
                        {% elif job.status == 'completed' and job.payment and job.payment.status == 'paid' %}
                            {% if job_reviews.get(job.id) %}
                                <button class="bg-gray-400 text-white px-4 py-2 rounded cursor-not-allowed" disabled>
                                    <i class="fas fa-star"></i> Review Submitted
                                </button>
                            {% else %}
                                <a href="{{ url_for('review_freelancer', job_id=job.id) }}" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
                                    <i class="fas fa-star"></i> Review
                                </a>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if pagination.pages > 1 %}
            <div class="flex justify-center gap-2 mt-6">
                {% if pagination.has_prev %}
                    <a href="{{ url_for('my_jobs', page=pagination.prev_num, status=status) }}" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100">Previous</a>
                {% endif %}
                
                {% for page_num in pagination.iter_pages(left_edge=1, left_current=1, right_current=1, right_edge=1) %}
                    {% if page_num %}
                        {% if page_num == pagination.page %}
                            <span class="px-4 py-2 bg-blue-600 text-white rounded">{{ page_num }}</span>
                        {% else %}
                            <a href="{{ url_for('my_jobs', page=page_num, status=status) }}" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100">{{ page_num }}</a>
                        {% endif %}
                    {% else %}
                        <span class="px-4 py-2">...</span>
                    {% endif %}
                {% endfor %}
                
                {% if pagination.has_next %}
                    <a href="{{ url_for('my_jobs', page=pagination.next_num, status=status) }}" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100">Next</a>
                {% endif %}
            </div>
        {% endif %}
    {% else %}
        <div class="bg-white p-12 rounded-lg shadow-md text-center">
            <p class="text-gray-600 text-lg mb-4">You haven't posted any jobs yet.</p>
            <a href="{{ url_for('post_job') }}" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                Post Your First Job
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}
